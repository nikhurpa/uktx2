<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Map Toolbox with Context Menu</title>
  <style>
    html, body, #map { height: 100%; margin: 0; }

    .toolbox {
      position: absolute; top: 12px; left: 12px; z-index: 5;
      background: #fff; border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      display: flex; gap: 6px; padding: 8px;
      font-family: system-ui, sans-serif;
    }
    .tool-btn {
      border: 1px solid #ddd; border-radius: 10px;
      padding: 8px 10px; cursor: pointer; font-size: 14px;
      background: #fafafa; user-select: none;
    }
    .tool-btn.active { background: #2563eb; color: #fff; border-color: #1d4ed8; }
    .status {
      position: absolute; top: 62px; left: 12px; z-index: 5;
      background: rgba(0,0,0,.75); color: #fff;
      padding: 6px 8px; border-radius: 6px; font-size: 13px;
    }
    .context-menu {
      position: absolute; background: white; border: 1px solid #ccc;
      border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,.2);
      padding: 6px 0; display: none; z-index: 10000;
      font-family: system-ui, sans-serif; font-size: 14px;
    }
    .context-menu div {
      padding: 6px 12px; cursor: pointer;
    }
    .context-menu div:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div class="toolbox">
    <div id="btnMarker" class="tool-btn">Marker</div>
    <div id="btnLine" class="tool-btn">Line</div>
    <div id="btnRoute" class="tool-btn">Route</div>
  </div>
  <div id="status" class="status">Select a modeâ€¦</div>
  <div id="map"></div>

  <div id="contextMenu" class="context-menu">
    <div id="menuView">View details</div>
    <div id="menuEdit">Edit details</div>
  </div>

  <!-- Async loader -->
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams;
    const f=()=>h||(h=new Promise(async(n,o)=>{await (a=m.createElement("script"));
    e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);
    e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;
    d[q]=n;a.onerror=()=>o(Error(p+" could not load."));m.head.append(a)}));
    d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(n,...o)=>r.add(n)&&f().then(()=>d[l](n,...o))})
    ({key:"AIzaSyAH06384nr0EpGqBZXDmkbGxHoWtpKjGPE", v:"weekly"});
  </script>

  <script>
let map, mode = null, statusEl, ctxMenu, selectedTarget;

async function initMap() {
  const { Map } = await google.maps.importLibrary("maps");
  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  map = new Map(document.getElementById("map"), {
    center: { lat: 28.6139, lng: 77.2090 },
    zoom: 14,
    mapId: "DEMO_MAP_ID"
  });

  statusEl = document.getElementById("status");
  ctxMenu = document.getElementById("contextMenu");

  bindToolButtons(AdvancedMarkerElement);

  // Hide context menu globally
  map.addListener("click", () => hideContextMenu());
  document.body.addEventListener("click", () => hideContextMenu());
}

function bindToolButtons(AdvancedMarkerElement) {
  document.getElementById("btnMarker").onclick = () => setMode("Marker");
  document.getElementById("btnLine").onclick = () => setMode("Line");
  document.getElementById("btnRoute").onclick = () => setMode("Route");

  // Marker mode
  map.addListener("click", (e) => {
    if (mode !== "Marker") return;

    const dot = document.createElement("div");
    dot.style.width = "14px"; dot.style.height = "14px";
    dot.style.borderRadius = "50%"; dot.style.background = "red";
    dot.style.border = "2px solid white";

    const marker = new AdvancedMarkerElement({
      position: e.latLng,
      map,
      content: dot
    });

    // Right-click via DOM event
    marker.content.addEventListener("contextmenu", (evt) => {
      evt.preventDefault();
      selectedTarget = marker;
      showContextMenu(evt, "Marker");
    });
  });

  // Line mode: click 2 points
  let linePoints = [];
  map.addListener("click", (e) => {
    if (mode !== "Line") return;

    linePoints.push(e.latLng);
    if (linePoints.length === 2) {
      const line = new google.maps.Polyline({
        path: linePoints, map,
        strokeColor: "blue", strokeWeight: 3
      });
      linePoints = [];

      line.addListener("rightclick", (ev) => {
        selectedTarget = line;
        showContextMenu(ev.domEvent, "Line");
      });
    }
  });

  // Route mode: drag polyline
  let drawing = false, routePath = [];
  const polyline = new google.maps.Polyline({
    map, strokeColor: "green", strokeWeight: 3
  });

  map.addListener("mousedown", (e) => {
    if (mode !== "Route") return;
    drawing = true;
    routePath = [e.latLng];
    polyline.setPath(routePath);
  });
  map.addListener("mousemove", (e) => {
    if (mode !== "Route" || !drawing) return;
    routePath.push(e.latLng);
    polyline.setPath(routePath);
  });
  map.addListener("mouseup", () => {
    if (mode !== "Route") return;
    drawing = false;
  });

  polyline.addListener("rightclick", (ev) => {
    selectedTarget = polyline;
    showContextMenu(ev.domEvent, "Route");
  });
}

function setMode(newMode) {
  mode = newMode;
  ["btnMarker","btnLine","btnRoute"].forEach(id=>{
    document.getElementById(id).classList.toggle("active", id==="btn"+newMode);
  });
  statusEl.textContent = `Mode: ${newMode}`;
}

function showContextMenu(domEvent, type) {
  ctxMenu.style.display = "block";
  ctxMenu.style.left = domEvent.pageX + "px";
  ctxMenu.style.top = domEvent.pageY + "px";
  statusEl.textContent = `${type} right-clicked`;
}

function hideContextMenu() {
  ctxMenu.style.display = "none";
}

    // Init
    initMap();
  </script>
</body>
</html>
